{% extends 'base.html' %}

{% block title %}Oyun Odası - {{ game.game_id|truncatechars:8 }}{% endblock %}

{% block extra_css %}
    <style>
        :root {
            --p1-color: #d90429; /* Canlı Kırmızı */
            --p2-color: #0077b6; /* Canlı Mavi */
            --board-bg: #212529; /* Koyu Gri */
            --cell-border: #495057;
            --cell-hover: #343a40;
        }

        #game-board-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: auto;
        }

        #game-board {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            border: 2px solid var(--cell-border);
            border-radius: 8px;
            width: 100%;
            aspect-ratio: 1 / 1;
            background-color: var(--board-bg);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        .cell {
            border: 1px solid var(--cell-border);
            box-sizing: border-box;
            font-size: 2.2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            color: #fff;
            position: relative;
        }

        .cell:hover {
            background-color: var(--cell-hover);
        }

        .cell.p1 { background-color: var(--p1-color); }
        .cell.p2 { background-color: var(--p2-color); }

        /* Patlama Animasyonu */
        .cell.explode::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #fff;
            border-radius: 50%;
            opacity: 0.7;
            animation: boom 0.4s ease-out;
        }

        @keyframes boom {
            0% { transform: scale(0.2); opacity: 0.7; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        /* YENİ: Başlangıç Çarkı Stilleri */
        #wheel-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            color: #fff;
            display: none; /* JS ile 'flex' yapılacak */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            border-radius: 8px;
            text-align: center;
            font-size: 1.5rem;
        }
        #wheel-spinner {
            font-size: 100px;
            margin-bottom: 20px;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #wheel-overlay.finished #wheel-spinner {
            animation: spin 0.5s linear 3, spin-stop 0.5s ease-out 1.5s forwards;
            color: #28a745; /* Yeşil */
        }
        @keyframes spin-stop {
            from { transform: rotate(0deg); }
            to { transform: rotate(720deg); }
        }

        /* Oyun Bitti Ekranı */
        #game-over-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.85);
            color: #fff;
            display: none; /* JS ile 'flex' yapılacak */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 8px;
            text-align: center;
        }

        /* Mesaj Logu Stilleri */
        #message-log {
            height: 250px;
            overflow-y: scroll;
            background: #343a40;
            border-radius: 0.25rem;
            border: 1px solid #495057;
            color: #f8f9fa;
        }
        #message-log p { margin: 0; padding: 2px 8px; }
    </style>
{% endblock %}


{% block content %}
    <h1 class="mb-4">Oyun Odası</h1>

    <div class="row">
        <div class="col-lg-7 col-md-8 mb-4">

            <div id="game-board-container">

                <div id="game-over-overlay">
                    <h2 class="mb-3">Oyun Bitti!</h2>
                    <h4 class="mb-4">Kazanan: <span id="winner-name">...</span></h4>
                    <a href="{% url 'game_lobby' %}" class="btn btn-primary btn-lg">Yeni Oyun</a>
                </div>

                <div id="wheel-overlay">
                    <div id="wheel-spinner"><i class="fas fa-compact-disc"></i></div>
                    <h4>Başlangıç sırası belirleniyor...</h4>
                    <h3 id="wheel-winner-name" class="mt-3" style="display: none;"></h3>
                </div>

                <div id="game-board">
                </div>
            </div>

        </div>

        <div class="col-lg-5 col-md-4">
            <div class="card shadow-sm text-bg-dark border-secondary">
                <div class="card-header fs-5 border-secondary">
                    Oyun Bilgileri
                </div>
                <div class="card-body">
                    <h5 id="turn-indicator" class="card-title mb-3">
                        Sıra: {{ game.current_turn.username|default:"Rakip bekleniyor..." }}
                    </h5>
                    <p class="mb-1">
                        <strong><i class="fas fa-circle text-danger"></i> Oyuncu 1:</strong> {{ game.player1.username }}
                    </p>
                    <p>
                        <strong><i class="fas fa-circle text-primary"></i> Oyuncu 2:</strong>
                        <span id="player2-name">{{ game.player2.username|default:"Rakip bekleniyor..." }}</span>
                    </p>

                    {% if is_spectator %}
                    <div class="alert alert-dark border-warning text-warning" role="alert">
                        <strong>İzleyici modundasınız.</strong> Hamle yapamazsınız.
                    </div>
                    {% endif %}

                    <hr class="border-secondary">

                    <label for="message-log" class="form-label">Oyun Kayıtları:</label>
                    <div id="message-log" class="p-2">
                        </div>

                    <a href="{% url 'game_lobby' %}" class="btn btn-secondary mt-3 w-100">Lobiden Ayrıl</a>
                </div>
            </div>
        </div>
    </div>

    {{ game_id_json|json_script:"game-id" }}
    {{ username_json|json_script:"current-username" }}
    {{ is_spectator|json_script:"is-spectator" }}
{% endblock %}
{% block extra_js %}
    <script>
        // DOM elementleri ve veriler
        const gameId = JSON.parse(document.getElementById('game-id').textContent);
        const myUsername = JSON.parse(document.getElementById('current-username').textContent);
        const isSpectator = JSON.parse(document.getElementById('is-spectator').textContent);

        const boardElement = document.getElementById('game-board');
        const turnIndicator = document.getElementById('turn-indicator');
        const player2Name = document.getElementById('player2-name');
        const messageLog = document.getElementById('message-log');

        // Overlay (Ekran) elementleri
        const gameOverOverlay = document.getElementById('game-over-overlay');
        const winnerNameEl = document.getElementById('winner-name');
        const wheelOverlay = document.getElementById('wheel-overlay');
        const wheelWinnerText = document.getElementById('wheel-winner-name');

        let player1Username = '{{ game.player1.username }}';
        let player2Username = '{{ game.player2.username|default_if_none:"" }}';

        const diceIcons = {
            1: 'fa-dice-one',
            2: 'fa-dice-two',
            3: 'fa-dice-three'
        };

        // Gecikme (uyku) fonksiyonu
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // WebSocket Bağlantısı
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const gameSocket = new WebSocket(
            wsProtocol + '//' + window.location.host + '/ws/game/' + gameId + '/'
        );

        // Sunucudan Mesaj Alma (GÜNCELLENMİŞ - Çark mantığı eklendi)
        gameSocket.onmessage = async function(e) {
            const data = JSON.parse(e.data);
            console.log("Sunucudan alındı:", data);

            if (data.type === 'error') {
                logMessage(data.message, 'danger');
                return;
            }

            if (data.type === 'game_state') {

                // --- 1. Oyuncu Adlarını Güncelle (P2 katılınca haberdar ol) ---
                player1Username = data.p1;
                player2Username = data.p2 || "";
                player2Name.textContent = data.p2 || "Rakip bekleniyor...";

                // --- 2. YENİ: Başlangıç Çarkı Animasyonu ---
                if (data.special_event === 'game_start_roll') {
                    // 1. Çarkı göster
                    wheelWinnerText.style.display = 'none';
                    wheelOverlay.classList.remove('finished');
                    wheelOverlay.style.display = 'flex';

                    // 2. Animasyonun bitmesini bekle (2.5 saniye)
                    await sleep(2500);

                    // 3. Sonucu göster
                    wheelWinnerText.innerHTML = `<i class="fas fa-check-circle"></i> ${data.turn} başlıyor!`;
                    wheelWinnerText.style.display = 'block';
                    wheelOverlay.classList.add('finished');

                    // 4. 2 saniye daha bekle ve çarkı gizle
                    await sleep(2000);
                    wheelOverlay.style.display = 'none';
                    logMessage(data.message, 'success');
                }

                // --- 3. Durum ve Sıra Göstergesi ---
                if (data.status === 'finished') {
                    turnIndicator.textContent = "Oyun Bitti!";
                    logMessage("Kazanan: " + data.winner, 'success');
                    winnerNameEl.textContent = data.winner;
                    gameOverOverlay.style.display = 'flex';

                } else if (data.status === 'waiting') {
                    turnIndicator.textContent = "Rakip bekleniyor...";
                } else {
                    turnIndicator.textContent = "Sıra: " + data.turn;
                }

                // --- 4. Sıralı Patlama Animasyonu ---
                if (data.exploded_cells && data.exploded_cells.length > 0) {
                    // Tahtayı *kilitle* (animasyon bitene kadar tıklanmasın)
                    boardElement.style.pointerEvents = 'none';

                    // Patlamaları SIRAYLA tetikle
                    await triggerSequentialExplosions(data.exploded_cells);

                    // Animasyon bitti, tahtayı son haliyle çiz
                    renderBoard(data.state);

                    // Tahtanın *kilidini aç*
                    boardElement.style.pointerEvents = 'auto';

                } else {
                    // Patlama yoksa, tahtayı hemen çiz
                    renderBoard(data.state);
                }

                if (data.message && data.special_event !== 'game_start_roll') {
                    logMessage(data.message, 'info');
                }
            }
        };

        gameSocket.onclose = function(e) {
            console.error('WebSocket bağlantısı kapandı.');
            logMessage('Sunucuyla bağlantı koptu. Sayfayı yenileyin.', 'danger');
            turnIndicator.textContent = "Bağlantı Kesildi";
        };

        gameSocket.onopen = function(e) {
            logMessage('Oyun masasına başarıyla bağlandınız.', 'success');
        };

        // Sıralı Patlama Fonksiyonu
        async function triggerSequentialExplosions(explodedCells) {
            const EXPLOSION_DELAY = 200; // Her patlama arası bekleme (ms)

            for (const coords of explodedCells) {
                const [r, c] = coords;
                const cellEl = boardElement.querySelector(`.cell[data-row="${r}"][data-col="${c}"]`);

                if (cellEl) {
                    // Patlama efektini ekle
                    cellEl.classList.add('explode');
                    // Bir sonraki patlamaya geçmeden önce bekle
                    await sleep(EXPLOSION_DELAY);

                    // Not: CSS animasyonu 400ms sürerken biz 200ms'de
                    // bir sonrakini tetikliyoruz. Bu, zincirleme
                    // reaksiyonun "üst üste binerek" akmasını sağlar.
                }
            }

            // Tüm patlamalar tetiklendikten sonra, sonuncusunun da
            // bitmesi için 400ms (CSS animasyon süresi) kadar bekle.
            await sleep(400);
        }

        // Tahta Çizme Fonksiyonu (Zar ikonlarıyla)
        function renderBoard(boardState) {
            boardElement.innerHTML = '';
            for (let r = 0; r < 5; r++) {
                for (let c = 0; c < 5; c++) {
                    const cellElement = document.createElement('div');
                    cellElement.classList.add('cell');
                    cellElement.dataset.row = r;
                    cellElement.dataset.col = c;

                    const cellData = boardState[r][c];

                    if (cellData && cellData.count > 0) {
                        if (diceIcons[cellData.count]) {
                            const icon = document.createElement('i');
                            icon.className = `fas ${diceIcons[cellData.count]}`;
                            cellElement.appendChild(icon);
                        } else {
                            cellElement.textContent = cellData.count; // 4+ için
                        }

                        if (cellData.owner === player1Username) {
                            cellElement.classList.add('p1');
                        } else if (cellData.owner === player2Username) {
                            cellElement.classList.add('p2');
                        }

                    } else {
                        cellElement.innerHTML = '';
                    }
                    boardElement.appendChild(cellElement);
                }
            }
        }

        // Hamle Gönderme (Tıklama)
        boardElement.addEventListener('click', function(e) {
            const cell = e.target.closest('.cell');
            if (!cell) return;
            if (isSpectator) {
                logMessage("İzleyiciler hamle yapamaz.", 'warning');
                return;
            }
            // "Oyun bitti" veya "Çark" ekranı açıksa tıklamayı engelle
            if (gameOverOverlay.style.display === 'flex' || wheelOverlay.style.display === 'flex') {
                return;
            }
            const row = cell.dataset.row;
            const col = cell.dataset.col;
            gameSocket.send(JSON.stringify({
                'type': 'make_move',
                'row': parseInt(row),
                'col': parseInt(col)
            }));
        });

        // Loglama Fonksiyonu
        function logMessage(msg, type = 'info') {
            let textClass = 'text-info';
            if (type === 'danger') { textClass = 'text-danger'; }
            else if (type === 'success') { textClass = 'text-success'; }
            else if (type === 'warning') { textClass = 'text-warning'; }

            const p = document.createElement('p');
            p.classList.add('m-0', 'small', textClass);
            p.textContent = msg;
            messageLog.appendChild(p);
            messageLog.scrollTop = messageLog.scrollHeight;
        }

        // İlk tahtayı çiz
        renderBoard({{ game.board_state|safe }});
    </script>
{% endblock %}