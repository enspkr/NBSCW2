{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    /* 1. ANA YAPI */
    .chat-container {
        height: 85vh;
        min-height: 500px;
        display: flex;
        flex-direction: column;
        border-radius: 8px;
        overflow: hidden;
        background-color: #36393f;
    }
    .chat-header {
        padding: 0.75rem 1rem;
        background-color: #2c2f33;
        border-bottom: 1px solid #212529;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }
    /* Ana içerik (Üyeler + Video/Sohbet) */
    .main-content-wrapper {
        flex-grow: 1;
        display: flex;
        flex-direction: row;
        overflow: hidden;
    }

    /* 2. ÜYE LİSTESİ (Sadece Masaüstü) */
    .member-list-desktop {
        flex-basis: 240px; /* Discord'un standart genişliği */
        flex-shrink: 0;
        background-color: #2c2f33;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        padding: 1rem;
    }
    .member-list-body {
        flex-grow: 1;
        overflow-y: auto;
    }
    .control-panel {
        flex-shrink: 0;
    }

    /* 3. ANA İÇERİK ALANI (Video + Sohbet) */
    .main-content-area {
        flex-grow: 1;
        display: flex;
        flex-direction: row; /* YAN YANA: Video ve Sohbet */
        overflow: hidden;
        background-color: #36393f;
    }

    /* 4. VİDEO IZGARASI (YENİ - AKILLI IZGARA) */
    .video-grid {
        flex-grow: 1; /* Kalan tüm alanı doldur */
        display: grid;
        /* * ANAHTAR: Otomatik sığdır. En az 300px'lik sütunlar oluştur,
         * sığdığı kadarını 1fr (eşit) olarak böl.
         * 4-5 kişi için mükemmel ızgara sağlar.
         */
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        grid-auto-rows: min-content; /* Yüksekliği içeriğe göre ayarla */
        gap: 10px;
        padding: 10px;
        background-color: #212529;
        overflow-y: auto;
    }
    .video-container {
        position: relative;
        width: 100%;
        /* 16:9 en-boy oranı (daha modern) */
        padding-bottom: 56.25%;
        height: 0;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer; /* Tıklanabilir olduğunu göster */
        transition: all 0.2s ease-in-out;
    }
    .video-container video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .video-label {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(0, 0, 0, 0.5);
        color: white;
        padding: 4px 8px;
        font-size: 0.9rem;
    }

    /* YENİ: Tıklayınca Büyütme (Spotlight) */
    .video-container.spotlight {
        position: absolute;
        top: 10px;
        left: 10px;
        width: calc(100% - 20px); /* Padding'i hesaba kat */
        height: calc(100% - 20px);
        padding-bottom: 0; /* Oranı geçersiz kıl */
        z-index: 100;
    }
    .video-grid:has(.spotlight) .video-container:not(.spotlight) {
        /* Biri büyütüldüğünde diğerlerini gizle */
        display: none;
    }

    /* 5. SOHBET ALANI (Sadece Masaüstü - Sağ Sütun) */
    .chat-area {
        flex-basis: 300px; /* Sohbet alanı genişliği */
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        background-color: #36393f;
        border-left: 1px solid #2c2f33;
    }
    .chat-messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 15px;
    }
    .chat-input {
        padding: 10px;
        border-top: 1px solid #2c2f33;
    }
    .chat-message { margin-bottom: 8px; word-wrap: break-word; }

    /* 6. YAN MENÜ (Offcanvas) Stilleri */
    .offcanvas {
        background-color: #2c2f33;
        color: white;
    }
    .member-name {
        font-size: 0.9rem;
        padding: 8px 10px;
        border-radius: 4px;
        margin-bottom: 5px;
    }
    .member-name:hover { background-color: rgba(255, 255, 255, 0.1); }
    .volume-slider {
        width: 90%;
        margin-left: auto;
        margin-right: auto;
        display: block;
    }
    .status-icons { margin-right: 5px; }

    /* MOBİL İÇİN ÖZEL KURALLAR (LG ekran altı) */
    @media (max-width: 991.98px) {
        .main-content-area {
            flex-direction: column; /* Mobilde Video ÜSTTE, Sohbet ALTTA */
        }
        .chat-area {
            flex-basis: auto; /* Genişliği sıfırla */
            height: 40vh; /* Mobilde sohbet yüksekliği */
            border-left: none;
            border-top: 1px solid #2c2f33;
        }
        .video-grid {
            /* Mobilde ızgara yerine yatay kaydırma daha iyi olabilir */
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            overflow-y: hidden;
            grid-template-columns: unset; /* Grid'i geçersiz kıl */
            height: 60vh; /* Mobilde video alanı yüksekliği */
        }
        .video-container {
            flex-shrink: 0;
            width: 240px; /* Mobilde sabit genişlik */
            height: 180px;
            padding-bottom: 0; /* Oranı geçersiz kıl */
        }
        .video-container.spotlight { /* Mobilde büyütme */
             width: calc(100% - 20px);
             height: calc(100% - 20px);
        }
    }
</style>
{% endblock %}


{% block content %}

<div class="offcanvas offcanvas-start" tabindex="-1" id="memberOffcanvas" aria-labelledby="memberOffcanvasLabel">
    <div class="offcanvas-header border-bottom border-secondary">
        <h5 class="offcanvas-title" id="memberOffcanvasLabel">
            <i class="bi bi-people-fill me-1"></i> Odadakiler
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column p-3">
        <div id="member-list-body-mobile" class="member-list-body"></div>
        <hr class="border-secondary mt-3">
        <div id="control-panel-mobile" class="control-panel">
            <button id="mute-btn-mobile" class="btn btn-warning w-100 mb-2"><i class="bi bi-mic-fill"></i> Mikrofon Kapat</button>
            <button id="deafen-btn-mobile" class="btn btn-secondary w-100 mb-2"><i class="bi bi-earbuds"></i> Sağırlaştır</button>
            <button id="video-btn-mobile" class="btn btn-info w-100 mb-2"><i class="bi bi-camera-video-fill"></i> Kamerayı Aç</button>
            <button id="leave-btn-mobile" class="btn btn-danger w-100"><i class="bi bi-box-arrow-left"></i> Odadan Ayrıl</button>
        </div>
    </div>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="chatOffcanvas" aria-labelledby="chatOffcanvasLabel">
    <div class="offcanvas-header border-bottom border-secondary">
        <h5 class="offcanvas-title" id="chatOffcanvasLabel">
            <i class="bi bi-chat-fill me-1"></i> Sohbet
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column p-0">
        <div class="chat-messages" id="chat-messages-mobile"></div>
        <div class="chat-input" id="chat-input-mobile">
            </div>
    </div>
</div>


<div class="chat-container">

    <div class="chat-header">
        <h4 class="mb-0 text-white"># {{ channel.name }}</h4>
        <div>
            <button class="btn btn-outline-light d-lg-none me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#chatOffcanvas" aria-controls="chatOffcanvas">
                <i class="bi bi-chat"></i>
            </button>
            <button class="btn btn-outline-light d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#memberOffcanvas" aria-controls="memberOffcanvas">
                <i class="bi bi-people"></i>
            </button>
        </div>
    </div>

    <div class="main-content-wrapper">

        <div class="d-none d-lg-flex member-list-desktop">
            <h5 class="text-light border-bottom border-secondary pb-2 mb-3">
                <i class="bi bi-people-fill me-1"></i> Odadakiler
            </h5>
            <div id="member-list-body" class="member-list-body">
                 <p class="text-muted">Bağlanılıyor...</p>
            </div>
            <hr class="border-secondary mt-3">
            <div id="control-panel-desktop" class="control-panel">
                 <button id="mute-btn" class="btn btn-warning w-100 mb-2"><i class="bi bi-mic-fill"></i> Mikrofon Kapat</button>
                <button id="deafen-btn" class="btn btn-secondary w-100 mb-2"><i class="bi bi-earbuds"></i> Sağırlaştır</button>
                <button id="video-btn" class="btn btn-info w-100 mb-2"><i class="bi bi-camera-video-fill"></i> Kamerayı Aç</button>
                <button id="leave-btn" class="btn btn-danger w-100"><i class="bi bi-box-arrow-left"></i> Odadan Ayrıl</button>
            </div>
        </div>

        <div class="main-content-area">

            <div class="video-grid" id="video-grid">
                </div>

            <div class="d-none d-lg-flex chat-area">
                <div class="chat-messages" id="chat-messages">
                    <p class="text-muted text-center">WebSocket bağlantısı bekleniyor...</p>
                </div>
                <div class="chat-input" id="chat-input-desktop">
                    <div class="input-group">
                        <input type="text" id="chat-message-input" class="form-control" placeholder="Mesajınızı buraya yazın..." aria-label="Mesaj">
                        <button class="btn btn-primary" type="button" id="chat-message-submit">Gönder</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}


{% block extra_js %}
<script>
    // --- TEMEL DEĞİŞKENLER ---
    const channelSlug = "{{ channel_slug }}";
    const currentUserID = "{{ request.user.id }}";
    const currentUsername = "{{ request.user.username }}";

    // UI Elementleri (Masaüstü)
    const messages = document.getElementById('chat-messages');
    const memberList = document.getElementById('member-list-body');
    const muteButton = document.getElementById('mute-btn');
    const deafenButton = document.getElementById('deafen-btn');
    const videoButton = document.getElementById('video-btn');
    const videoGrid = document.getElementById('video-grid');
    const leaveButton = document.getElementById('leave-btn');
    const chatInputDesktop = document.getElementById('chat-input-desktop'); // Değişti
    const chatMessageInput = document.getElementById('chat-message-input');
    const chatSubmit = document.getElementById('chat-message-submit');

    // UI Elementleri (Mobil)
    const messagesMobile = document.getElementById('chat-messages-mobile'); // Yeni
    const chatInputMobile = document.getElementById('chat-input-mobile'); // Yeni
    const memberListMobile = document.getElementById('member-list-body-mobile');
    const muteButtonMobile = document.getElementById('mute-btn-mobile');
    const deafenButtonMobile = document.getElementById('deafen-btn-mobile');
    const videoButtonMobile = document.getElementById('video-btn-mobile');
    const leaveButtonMobile = document.getElementById('leave-btn-mobile');

    // --- WEBRTC SUNUCU AYARLARI ---
    const iceServers = { 'iceServers': [{'urls': 'stun:stun.l.google.com:19302'}] };

    // --- HARİTALAR VE DURUMLAR ---
    let peerConnections = {};
    let remoteAudioElements = {};
    let remoteStreams = {};
    let localStream = null;
    let localVideoTrack = null;
    let localVideoElement = null;
    let isMuted = false;
    let isDeafened = false;
    let masterVolume = parseFloat(localStorage.getItem('masterVolume')) || 1.0;

    // --- 1. MOBİL SOHBET INPUT'UNU KOPYALA ---
    // Masaüstü input'u mobil offcanvas'a klonla (senkronize çalışsınlar)
    chatInputMobile.appendChild(chatInputDesktop.cloneNode(true));
    const chatMessageInputMobile = document.getElementById('chat-input-mobile').querySelector('input');
    const chatSubmitMobile = document.getElementById('chat-input-mobile').querySelector('button');

    // --- 2. WEBSOCKET BAĞLANTISI ---
    const voiceSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/voice/' + '?channel_slug=' + channelSlug
    );

    // --- 3. SİNYAL GÖNDERME FONKSİYONLARI ---
    function sendWebRTCSignal(signalType, data, recipientId = null) {
        voiceSocket.send(JSON.stringify({
            'signal_type': signalType, 'recipient_id': recipientId, 'data': data
        }));
    }
    function sendChatMessage(message) {
        voiceSocket.send(JSON.stringify({
            'signal_type': 'chat_message', 'data': message
        }));
    }
    function sendStatusUpdate(statusData) {
         voiceSocket.send(JSON.stringify({
            'signal_type': 'status_update', 'data': statusData
        }));
    }

    // --- 4. YEREL AKIŞLARI ALMA ---
    async function startLocalStream() { // Sadece Ses
        const preferredInputId = localStorage.getItem('preferredAudioInput');
        const constraints = {
            audio: { deviceId: preferredInputId ? { exact: preferredInputId } : undefined },
            video: false
        };
        try {
            localStream = await navigator.mediaDevices.getUserMedia(constraints);
            return true;
        } catch (e) {
            console.error("Mikrofon erişimi engellendi:", e);
            alert("Sesli sohbete katılmak için mikrofon erişimine izin vermelisiniz.");
            return false;
        }
    }

    async function startLocalVideo() { // Sadece Video
        try {
            const videoStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            localVideoTrack = videoStream.getVideoTracks()[0];
            createLocalVideoElement();
            for (let userId in peerConnections) {
                peerConnections[userId].addTrack(localVideoTrack, videoStream);
            }
            updateVideoButtonUI(true);
            return true;
        } catch (e) {
            console.error("Kamera erişimi engellendi:", e);
            alert("Kamera erişimine izin verilmedi.");
            const errorMsg = "Kamera Açılamadı";
            [videoButton, videoButtonMobile].forEach(btn => {
                btn.innerHTML = `<i class="bi bi-camera-video-fill"></i> ${errorMsg}`;
                btn.classList.add('btn-secondary'); btn.classList.remove('btn-info');
                btn.disabled = true;
            });
            return false;
        }
    }

    function createLocalVideoElement() {
        localVideoElement = document.createElement('div');
        localVideoElement.id = `video-${currentUserID}`;
        localVideoElement.className = 'video-container';

        const videoEl = document.createElement('video');
        videoEl.autoplay = true; videoEl.playsInline = true; videoEl.muted = true;
        videoEl.srcObject = new MediaStream([localVideoTrack]);

        const nameLabel = document.createElement('div');
        nameLabel.className = 'video-label';
        nameLabel.innerText = `${currentUsername} (Siz)`;

        localVideoElement.appendChild(videoEl);
        localVideoElement.appendChild(nameLabel);
        videoGrid.prepend(localVideoElement); // Kendi videomuzu başa ekle
    }

    // --- 5. WEBRTC BAĞLANTISI OLUŞTURMA ---
    async function createPeerConnection(remoteUserID, isInitiator = false) {
        if (peerConnections[remoteUserID]) return;
        const pc = new RTCPeerConnection(iceServers);
        peerConnections[remoteUserID] = pc;

        localStream.getTracks().forEach(track => {
            pc.addTrack(track, localStream);
        });
        if (localVideoTrack && localVideoTrack.enabled) {
            pc.addTrack(localVideoTrack, new MediaStream([localVideoTrack]));
        }

        pc.onicecandidate = (event) => {
            if (event.candidate) {
                sendWebRTCSignal('ice_candidate', event.candidate, remoteUserID);
            }
        };

        pc.ontrack = (event) => {
            if (!remoteStreams[remoteUserID]) {
                remoteStreams[remoteUserID] = new MediaStream();
            }
            remoteStreams[remoteUserID].addTrack(event.track);

            if (event.track.kind === 'audio') {
                if (!remoteAudioElements[remoteUserID]) {
                    const remoteAudio = document.createElement('audio');
                    remoteAudio.autoplay = true;
                    remoteAudio.srcObject = remoteStreams[remoteUserID];
                    remoteAudio.volume = masterVolume;
                    remoteAudio.muted = isDeafened;
                    const preferredOutputId = localStorage.getItem('preferredAudioOutput');
                    if (remoteAudio.setSinkId && preferredOutputId) {
                        remoteAudio.setSinkId(preferredOutputId);
                    }
                    remoteAudioElements[remoteUserID] = remoteAudio;
                    document.body.appendChild(remoteAudio);
                }
            }
            else if (event.track.kind === 'video') {
                let videoContainer = document.getElementById(`video-${remoteUserID}`);
                if (!videoContainer) {
                    videoContainer = document.createElement('div');
                    videoContainer.id = `video-${remoteUserID}`;
                    videoContainer.className = 'video-container';

                    const memberDiv = document.getElementById(`member-${remoteUserID}`);
                    const username = memberDiv ? (memberDiv.dataset.username || remoteUserID) : remoteUserID;

                    const nameLabel = document.createElement('div');
                    nameLabel.className = 'video-label';
                    nameLabel.innerText = username;

                    const videoEl = document.createElement('video');
                    videoEl.autoplay = true; videoEl.playsInline = true;
                    videoEl.srcObject = remoteStreams[remoteUserID];

                    videoContainer.appendChild(videoEl);
                    videoContainer.appendChild(nameLabel);
                    videoGrid.appendChild(videoContainer);
                }
            }
        };

        pc.onconnectionstatechange = (event) => {
             if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed' || pc.connectionState === 'closed') {
                 console.log(`Bağlantı kesildi: ${remoteUserID}`);
                 delete peerConnections[remoteUserID];
                 const videoContainer = document.getElementById(`video-${remoteUserID}`);
                 if (videoContainer) videoContainer.remove();
                 delete remoteStreams[remoteUserID];
                 if (remoteAudioElements[remoteUserID]) {
                     remoteAudioElements[remoteUserID].remove();
                     delete remoteAudioElements[remoteUserID];
                 }
             }
        };

        if (isInitiator) {
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            sendWebRTCSignal('offer', pc.localDescription, remoteUserID);
        }
    }

    // --- 6. WEBSOCKET OLAY İŞLEYİCİLERİ ---

    voiceSocket.onopen = async function(e) {
        messages.innerHTML = `<div class="chat-message text-success text-center fst-italic">Bağlantı kuruldu.</div>`;
        messagesMobile.innerHTML = `<div class="chat-message text-success text-center fst-italic">Bağlantı kuruldu.</div>`;
        memberList.innerHTML = '';
        memberListMobile.innerHTML = '';

        const streamReady = await startLocalStream();
        if (streamReady) {
            const selfHtml = `
                <div id="member-${currentUserID}" class="member-name text-success" data-username="${currentUsername}">
                    <div><span class="status-icons" id="icons-${currentUserID}"></span><span>${currentUsername} (Siz)</span></div>
                </div>`;
            const selfHtmlMobile = `
                <div id="member-${currentUserID}-mobile" class="member-name text-success" data-username="${currentUsername}">
                    <div><span class="status-icons" id="icons-${currentUserID}-mobile"></span><span>${currentUsername} (Siz)</span></div>
                </div>`;
            memberList.innerHTML += selfHtml;
            memberListMobile.innerHTML += selfHtmlMobile;
            await startLocalVideo(); // Kamerayı otomatik başlat
        } else {
             alert("Mikrofon izni olmadan sesli sohbete katılamazsınız.");
             window.location.href = '{% url "index" %}';
        }
    };

    voiceSocket.onclose = function(e) {
        messages.innerHTML += `<div class="alert alert-danger">Bağlantı kesildi. Sayfayı yenileyin.</div>`;
        messagesMobile.innerHTML += `<div class="alert alert-danger">Bağlantı kesildi. Sayfayı yenileyin.</div>`;
        leaveButton.click();
    };

    voiceSocket.onmessage = async function(e) {
        const data = JSON.parse(e.data);
        const senderId = data.sender_id;

        if (senderId && senderId == currentUserID) return;

        if (data.type === 'system_notification') {
            const msgHtml = `<div class="chat-message text-info text-center fst-italic">${data.message}</div>`;
            messages.innerHTML += msgHtml;
            messagesMobile.innerHTML += msgHtml;

            if (data.event === 'member_joined' && senderId !== currentUserID) {
                 const memberHtml = `
                    <div id="member-${senderId}" class="member-name" data-username="${data.username}">
                        <div><span class="status-icons" id="icons-${senderId}"></span><span>${data.username}</span></div>
                        <input type="range" id="volume-${senderId}" min="0" max="1" step="0.01" value="${masterVolume}" class="form-range form-range-sm mt-1 volume-slider" title="${data.username} ses seviyesi">
                    </div>`;
                 const memberHtmlMobile = `
                    <div id="member-${senderId}-mobile" class="member-name" data-username="${data.username}">
                        <div><span class="status-icons" id="icons-${senderId}-mobile"></span><span>${data.username}</span></div>
                        <input type="range" id="volume-${senderId}-mobile" min="0" max="1" step="0.01" value="${masterVolume}" class="form-range form-range-sm mt-1 volume-slider" title="${data.username} ses seviyesi">
                    </div>`;
                 memberList.innerHTML += memberHtml;
                 memberListMobile.innerHTML += memberHtmlMobile;
                await createPeerConnection(senderId, true);
            }

            if (data.event === 'member_left') {
                const memberDiv = document.getElementById(`member-${senderId}`);
                if (memberDiv) memberDiv.remove();
                const memberDivMobile = document.getElementById(`member-${senderId}-mobile`);
                if (memberDivMobile) memberDivMobile.remove();

                if (peerConnections[senderId]) {
                    peerConnections[senderId].close();
                    delete peerConnections[senderId];
                }
                const videoContainer = document.getElementById(`video-${senderId}`);
                if (videoContainer) videoContainer.remove();
                if (remoteAudioElements[senderId]) {
                    remoteAudioElements[senderId].remove();
                    delete remoteAudioElements[senderId];
                }
                delete remoteStreams[senderId];
            }

        } else if (data.type === 'webrtc_signal') {

            if (data.recipient_id && data.recipient_id !== currentUserID) { return; }

            if (data.signal_type === 'offer') {
                if (!peerConnections[senderId]) { await createPeerConnection(senderId, false); }
                const pc = peerConnections[senderId];
                await pc.setRemoteDescription(new RTCSessionDescription(data.data));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                sendWebRTCSignal('answer', pc.localDescription, senderId);
            }
            else if (data.signal_type === 'answer') {
                const pc = peerConnections[senderId];
                if (pc) { await pc.setRemoteDescription(new RTCSessionDescription(data.data)); }
            }
            else if (data.signal_type === 'ice_candidate') {
                const pc = peerConnections[senderId];
                if (pc) {
                    try { await pc.addIceCandidate(new RTCIceCandidate(data.data)); }
                    catch (err) { console.error("ICE adayı eklenemedi:", err); }
                }
            }

        } else if (data.type === 'member_status_update') {
            const muted = data.status.muted;
            const deafened = data.status.deafened;
            const iconSpans = document.querySelectorAll(`#icons-${senderId}, #icons-${senderId}-mobile`);
            iconSpans.forEach(span => {
                if (!span) return;
                let icons = '';
                if (deafened) { icons += '<i class="bi bi-ear-slash-fill text-danger me-1"></i>'; }
                if (muted && !deafened) { icons += '<i class="bi bi-mic-mute-fill text-danger me-1"></i>'; }
                span.innerHTML = icons;
            });

        } else if (data.type === 'chat_message') {
            const msgHtml = `
                <div class="chat-message">
                    <strong class="text-warning">${data.username}:</strong>
                    <span>${data.message}</span>
                </div>`;
            messages.innerHTML += msgHtml;
            messagesMobile.innerHTML += msgHtml;
        }

        messages.scrollTop = messages.scrollHeight;
        messagesMobile.scrollTop = messagesMobile.scrollHeight;
    };

    // --- 7. KULLANICI ARAYÜZÜ ETKİLEŞİMLERİ ---

    // Sohbet Gönderme (Masaüstü ve Mobil)
    function handleChatSubmit(inputElement, messageContainer) {
        const message = inputElement.value;
        if (message.trim() === '') return;
        sendChatMessage(message);

        const msgHtml = `<div class="chat-message text-end"><span class="badge bg-primary me-2">Siz</span> ${message}</div>`;
        messages.innerHTML += msgHtml;
        messagesMobile.innerHTML += msgHtml;

        inputElement.value = '';
        messages.scrollTop = messages.scrollHeight;
        messagesMobile.scrollTop = messagesMobile.scrollHeight;
    }

    chatSubmit.onclick = () => handleChatSubmit(chatMessageInput, messages);
    chatSubmitMobile.onclick = () => handleChatSubmit(chatMessageInputMobile, messagesMobile);
    chatMessageInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') chatSubmit.click(); });
    chatMessageInputMobile.addEventListener('keyup', (e) => { if (e.key === 'Enter') chatSubmitMobile.click(); });


    // --- Buton Senkronizasyon Fonksiyonları ---
    function updateMuteButtonUI(muted) {
        isMuted = muted;
        const icon = isMuted ? 'bi-mic-mute-fill' : 'bi-mic-fill';
        const text = isMuted ? 'Ses Kapalı' : 'Mikrofon Kapat';
        const [add, rem] = isMuted ? ['btn-dark', 'btn-warning'] : ['btn-warning', 'btn-dark'];
        [muteButton, muteButtonMobile].forEach(btn => {
            btn.innerHTML = `<i class="bi ${icon}"></i> ${text}`;
            btn.classList.add(add); btn.classList.remove(rem);
        });
        sendStatusUpdate({'muted': isMuted, 'deafened': isDeafened});
    }

    function updateDeafenButtonUI(deafened) {
        isDeafened = deafened;
        const icon = isDeafened ? 'bi-ear-slash-fill' : 'bi-earbuds';
        const text = isDeafened ? 'Sağırlaştırıldı' : 'Sağırlaştır';
        const [add, rem] = deafened ? ['btn-danger', 'btn-secondary'] : ['btn-secondary', 'btn-danger'];
        [deafenButton, deafenButtonMobile].forEach(btn => {
            btn.innerHTML = `<i class="bi ${icon}"></i> ${text}`;
            btn.classList.add(add); btn.classList.remove(rem);
        });
        sendStatusUpdate({'muted': isMuted, 'deafened': isDeafened});
    }

    function updateVideoButtonUI(enabled) {
        const icon = enabled ? 'bi-camera-video-off-fill' : 'bi-camera-video-fill';
        const text = enabled ? 'Kamerayı Kapat' : 'Kamerayı Aç';
        const [add, rem] = enabled ? ['btn-danger', 'btn-info'] : ['btn-info', 'btn-danger'];
        [videoButton, videoButtonMobile].forEach(btn => {
            btn.innerHTML = `<i class="bi ${icon}"></i> ${text}`;
            btn.classList.add(add); btn.classList.remove(rem);
        });
    }

    // Mute Butonları
    [muteButton, muteButtonMobile].forEach(btn => btn.addEventListener('click', () => {
        if (!localStream) return;
        if (isDeafened) {
            updateMuteButtonUI(true); return;
        }
        localStream.getAudioTracks().forEach(track => { track.enabled = isMuted; });
        updateMuteButtonUI(!isMuted);
    }));

    // Deafen Butonları
    [deafenButton, deafenButtonMobile].forEach(btn => btn.addEventListener('click', () => {
        const newDeafenState = !isDeafened;
        if (newDeafenState && !isMuted) {
            localStream.getAudioTracks().forEach(track => { track.enabled = false; });
            updateMuteButtonUI(true);
        }
        for (let userId in remoteAudioElements) {
            remoteAudioElements[userId].muted = newDeafenState;
        }
        updateDeafenButtonUI(newDeafenState);
    }));

    // Video Butonları
    [videoButton, videoButtonMobile].forEach(btn => btn.addEventListener('click', async () => {
        if (!localVideoTrack) return;
        localVideoTrack.enabled = !localVideoTrack.enabled;
        if (localVideoElement) {
            localVideoElement.style.display = localVideoTrack.enabled ? 'block' : 'none';
        }
        updateVideoButtonUI(localVideoTrack.enabled);
    }));

    // Bireysel Ses Ayarı (İki liste için de çalışır)
    [memberList, memberListMobile].forEach(list => list.addEventListener('input', (e) => {
        if (e.target.type === 'range' && e.target.id.startsWith('volume-')) {
            const userId = e.target.id.split('-')[1].replace('-mobile', '');
            const volume = e.target.value;
            const audioEl = remoteAudioElements[userId];
            if (audioEl) { audioEl.volume = volume; }

            const otherSliderId = e.target.id.includes('-mobile') ? `#volume-${userId}` : `#volume-${userId}-mobile`;
            const otherSlider = document.querySelector(otherSliderId);
            if (otherSlider) otherSlider.value = volume;
        }
    }));

    // Ayrılma Butonları
    [leaveButton, leaveButtonMobile].forEach(btn => btn.addEventListener('click', () => {
        for (let userId in peerConnections) {
            if(peerConnections[userId]) peerConnections[userId].close();
        }
        peerConnections = {};
        for (let userId in remoteAudioElements) {
            if(remoteAudioElements[userId]) remoteAudioElements[userId].remove();
        }
        remoteAudioElements = {};
        videoGrid.innerHTML = '';
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
        }
        if (localVideoTrack) {
            localVideoTrack.stop();
        }
        if (voiceSocket.readyState === WebSocket.OPEN) {
            voiceSocket.close();
        }
        window.location.href = '{% url "index" %}';
    }));

    // YENİ: Tıklayınca Büyütme (Spotlight)
    videoGrid.addEventListener('click', (e) => {
        const clickedVideoContainer = e.target.closest('.video-container');
        if (!clickedVideoContainer) return;

        // Zaten büyütülmüş mü?
        if (clickedVideoContainer.classList.contains('spotlight')) {
            clickedVideoContainer.classList.remove('spotlight');
        } else {
            // Diğer tüm büyütülmüşleri küçült
            videoGrid.querySelectorAll('.spotlight').forEach(el => el.classList.remove('spotlight'));
            // Bunu büyüt
            clickedVideoContainer.classList.add('spotlight');
        }
    });

</script>
{% endblock %}